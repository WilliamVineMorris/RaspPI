# Hardware PWM Setup Guide - CRITICAL FIX

## The Problem

You're seeing LED flickering because the system is using **software PWM** instead of **hardware PWM**.

**Software PWM** (current state):
- Generated by Python code timing
- Affected by CPU load from console logging, SSH, etc.
- Causes visible flickering during any I/O operations
- Works on any GPIO pin but unreliable

**Hardware PWM** (required state):
- Generated by dedicated hardware circuitry on the Pi
- Completely immune to CPU load and timing jitter
- Zero flickering even during heavy console activity
- Only available on GPIO 12, 13, 18, 19

## The Root Cause

`gpiozero` with the **RPi.GPIO factory** (default) uses software PWM on ALL pins, even GPIO 13 and 18 which are hardware PWM capable!

To get true hardware PWM, you MUST use the **pigpio factory** with `gpiozero`.

## The Solution - 3 Steps

### Step 1: Install pigpio Daemon

Run the setup script:
```bash
cd ~/Documents/RaspPI/V2.0
chmod +x setup_hardware_pwm.sh
./setup_hardware_pwm.sh
```

This will:
- Install pigpio library and daemon
- Start the pigpio daemon
- Configure it to start automatically at boot

**Manual Installation** (if script fails):
```bash
sudo apt update
sudo apt install -y pigpio python3-pigpio
sudo pigpiod
sudo systemctl enable pigpiod
```

**Verify pigpio is running**:
```bash
pgrep -x pigpiod
# Should output a process ID number
```

### Step 2: Configuration Already Updated

The configuration file has been updated:
```yaml
lighting:
  controller_type: "gpiozero"
  use_pigpio_factory: true  # â† Changed from false to true
  pwm_frequency: 100
```

This tells the LED controller to use the pigpio factory for hardware PWM.

### Step 3: Test Hardware PWM

```bash
cd ~/Documents/RaspPI/V2.0
python3 test_hardware_pwm.py
```

**Expected output at startup**:
```
âš¡ Using gpiozero with PIGPIO FACTORY - Hardware PWM on GPIO 13/18 at 100Hz
âš¡ This provides TRUE hardware PWM immune to CPU load!
âš¡ GPIO 13 using HARDWARE PWM via pigpio factory (flicker-free!)
âš¡ GPIO 18 using HARDWARE PWM via pigpio factory (flicker-free!)
```

**During TEST 2** (100 rapid console messages):
- **SUCCESS**: LEDs stay perfectly stable = Hardware PWM working! ğŸ‰
- **FAIL**: LEDs flicker = Still using software PWM (pigpio not running)

## Troubleshooting

### "LEDs still flicker during TEST 2"

This means pigpio daemon is not running or not being used.

**Check 1**: Is pigpio daemon running?
```bash
pgrep -x pigpiod
# Should show a number (process ID)
```

If empty, start it:
```bash
sudo pigpiod
```

**Check 2**: Restart the scanner application
```bash
sudo pkill -f run_web_interface
cd ~/Documents/RaspPI/V2.0
python3 run_web_interface.py
```

Check logs for "PIGPIO FACTORY" message.

**Check 3**: Check Python can connect to pigpio
```bash
python3 -c "import pigpio; pi = pigpio.pi(); print('Connected!' if pi.connected else 'Failed')"
# Should print "Connected!"
```

### "Cannot import pigpio"

Install the Python package:
```bash
pip install pigpio
# or
sudo apt install python3-pigpio
```

### "pigpiod failed to start"

Check if it's already running:
```bash
sudo killall pigpiod
sleep 1
sudo pigpiod
```

Check pigpio logs:
```bash
journalctl -u pigpiod -n 50
```

### "Warning: GPIO 13/18 CAN use hardware PWM but pigpio factory not enabled"

This means:
1. Config has `use_pigpio_factory: true` âœ…
2. But pigpio daemon is not running or not accessible âŒ

Solution:
```bash
sudo pigpiod
# Then restart scanner application
```

## Verification Checklist

After setup, verify ALL of these:

âœ… **pigpio daemon running**: `pgrep -x pigpiod` shows process ID  
âœ… **Python can connect**: Test import (see Check 3 above)  
âœ… **Config updated**: `use_pigpio_factory: true` in scanner_config.yaml  
âœ… **Startup logs show**: "Using gpiozero with PIGPIO FACTORY"  
âœ… **Zone init shows**: "GPIO 13/18 using HARDWARE PWM via pigpio factory"  
âœ… **TEST 2 passes**: Zero flickering during 100 console messages  
âœ… **Production scan**: Zero flickering during actual scans  

## Technical Details

### Why RPi.GPIO Factory Doesn't Work

The `RPi.GPIO` library (and its gpiozero factory) implements PWM using **software timing**:
```python
# Software PWM timing loop (simplified)
while True:
    GPIO.output(pin, HIGH)
    time.sleep(duty_cycle / frequency)
    GPIO.output(pin, LOW)
    time.sleep((1 - duty_cycle) / frequency)
```

Any CPU activity (logging, SSH, I/O) delays these `time.sleep()` calls, causing visible flicker.

### Why pigpio Factory Works

The `pigpio` library uses the Pi's **DMA hardware** to generate PWM signals:
- PWM signal generated by DMA controller, not CPU
- Timing handled by hardware clock, not Python
- Completely independent of CPU load
- Works on GPIO 12, 13, 18, 19 (hardware PWM pins)

### Frequency Selection

**100Hz** is optimal because:
- High enough to be invisible (>60Hz flicker fusion threshold)
- Low enough to be extremely stable and efficient
- Less CPU overhead than 300Hz or 1000Hz
- More tolerant of any timing variations

## Alternative: Direct pigpio (Not Recommended)

You could use pigpio directly instead of gpiozero:
```yaml
lighting:
  controller_type: "pigpio"  # Direct pigpio instead of gpiozero
```

But gpiozero with pigpio factory is preferred because:
- Same hardware PWM performance
- Simpler API and error handling
- Better integration with modern Pi systems
- Cleaner shutdown and resource management

## Expected Results

After proper setup:

**Before** (RPi.GPIO factory - software PWM):
- Flickering visible during console logging âŒ
- Flickering during SSH activity âŒ
- Flickering during camera operations âŒ
- TEST 2 shows obvious flickering âŒ

**After** (pigpio factory - hardware PWM):
- Zero flickering during console logging âœ…
- Zero flickering during SSH activity âœ…
- Zero flickering during camera operations âœ…
- TEST 2 shows perfectly stable LEDs âœ…

## Production Scanning

After hardware PWM is working:

```bash
cd ~/Documents/RaspPI/V2.0
python3 run_web_interface.py
```

Access web interface and run a scan. You should see:
- LEDs turn on smoothly (no flicker)
- Remain stable during calibration (no flicker)
- Remain stable during all capture points (no flicker)
- Turn off smoothly at end (no flicker)

Logs should show only 4 LED UPDATE messages total:
```
ğŸ’¡ LED UPDATE: Zone 'inner' 0.0% â†’ 30.0% (state: ON)
ğŸ’¡ LED UPDATE: Zone 'outer' 0.0% â†’ 30.0% (state: ON)
[... calibration and scanning with zero LED updates ...]
ğŸ’¡ LED UPDATE: Zone 'inner' 30.0% â†’ 0.0% (state: OFF)
ğŸ’¡ LED UPDATE: Zone 'outer' 30.0% â†’ 0.0% (state: OFF)
```

## Summary

The complete fix requires **BOTH**:
1. âœ… Software fix: "all" zone handling (already done)
2. âœ… Hardware PWM: pigpio factory (this guide)

Without hardware PWM via pigpio, the flickering will persist no matter how perfect the software is!
