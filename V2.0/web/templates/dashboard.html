{% extends "base.html" %}

{% block title %}Dashboard - 3D Scanner Control{% endblock %}

{% block head %}
<style>
    .camera-controls-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .control-group {
        background: white;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    
    .control-group label {
        color: #495057;
        font-weight: 600;
    }
    
    .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }
    
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: #ddd;
        border-radius: 3px;
        outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
    
    .status-info { color: #17a2b8; }
    .status-success { color: #28a745; }
    .status-error { color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- System Status Panel -->
    <section class="status-panel">
        <h2>System Status</h2>
        <div class="status-grid">
            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Motion Controller</span>
                    <span class="status-indicator" id="motionStatus">‚óè</span>
                </div>
                <div class="status-details" id="motionDetails">
                    <div>Position: <span id="currentPosition">X:0.0 Y:0.0 Z:0.0 C:0.0</span></div>
                    <div>State: <span id="motionState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Cameras</span>
                    <span class="status-indicator" id="cameraStatus">‚óè</span>
                </div>
                <div class="status-details" id="cameraDetails">
                    <div>Available: <span id="cameraCount">0</span></div>
                    <div>Active: <span id="activeCameras">None</span></div>
                    <div>State: <span id="cameraState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Lighting</span>
                    <span class="status-indicator" id="lightingStatus">‚óè</span>
                </div>
                <div class="status-details" id="lightingDetails">
                    <div>Zones: <span id="lightingZones">0</span></div>
                    <div>Status: <span id="lightingState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Current Scan</span>
                    <span class="status-indicator" id="scanStatus">‚óè</span>
                </div>
                <div class="status-details" id="scanDetails">
                    <div>Progress: <span id="scanProgress">---%</span></div>
                    <div>Points: <span id="scanPoints">0/0</span></div>
                    <div>Phase: <span id="scanPhase">Idle</span></div>
                    <div>State: <span id="scanState">Unknown</span></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions Panel -->
    <section class="actions-panel">
        <h2>Quick Actions</h2>
        <div class="action-grid">
            <button class="action-btn primary" onclick="homeAllAxes()" id="homeAllBtn">
                üè† Home All
            </button>
            <button class="action-btn secondary" onclick="capturePhoto()" id="captureBtn">
                üì∏ Capture Photo
            </button>
            <button class="action-btn secondary" onclick="testLighting()" id="lightTestBtn">
                ‚ö° Test Lighting
            </button>
            <button class="action-btn tertiary" onclick="window.location.href='/manual'">
                üéÆ Manual Control
            </button>
            <button class="action-btn tertiary" onclick="window.location.href='/scans'">
                üìä Start Scan
            </button>
            <button class="action-btn tertiary" onclick="refreshStatus()">
                üîÑ Refresh Status
            </button>
        </div>
    </section>

    <!-- Camera Feeds Panel -->
    <section class="camera-panel">
        <h2>Live Camera Feed</h2>
        <div class="camera-grid">
            <div class="camera-container" style="grid-column: 1 / -1; max-width: 800px; margin: 0 auto;">
                <h3>Camera 0 - Native 1080p Stream</h3>
                <div class="camera-feed-wrapper">
                    <img id="camera0Feed" 
                         src="/camera/0?t=0" 
                         alt="Camera 0 - 1080p Stream" 
                         class="camera-feed"
                         style="width: 100%; height: auto; border-radius: 8px; max-width: 1080px;"
                         onload="cameraStreamWorking = true; console.log('Camera 0 native 1080p stream loaded');"
                         onerror="console.log('Camera 0 stream error, retrying...'); setTimeout(() => { const timestamp = Date.now(); this.src = '/camera/0?t=' + timestamp; }, 2000);">
                    <div class="camera-overlay">
                        <button class="camera-control" onclick="captureFromCamera(0)">üì∏ Capture High-Res</button>
                    </div>
                </div>
                <div class="camera-info">
                    <small>üé• Live 1080p stream ‚Ä¢ üì∏ High-res capture available during scanning</small>
                </div>
                
                <!-- Camera Controls -->
                <div class="camera-controls-panel" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Camera Controls</h4>
                    <div class="controls-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Focus Controls -->
                        <div class="control-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Focus Control</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="btn btn-sm btn-primary" onclick="triggerAutofocus()">üéØ Auto Focus</button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleManualFocus()">‚öôÔ∏è Manual</button>
                                <button id="stabilizeBtn" class="btn btn-sm btn-warning" onclick="toggleStabilization()">üîß Stabilize</button>
                            </div>
                            <div id="manualFocusPanel" style="display: none;">
                                <label for="focusSlider" style="font-size: 12px;">Focus Position (0=Near, 10=Far)</label>
                                <input type="range" id="focusSlider" min="0" max="10" step="0.1" value="5" 
                                       style="width: 100%;" onchange="setManualFocus(this.value)">
                                <span id="focusValue" style="font-size: 12px;">5.0</span>
                            </div>
                        </div>
                        
                        <!-- Exposure Controls -->
                        <div class="control-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Exposure Control</label>
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; font-size: 14px;">
                                    <input type="checkbox" id="autoExposure" checked onchange="toggleAutoExposure(this.checked)">
                                    <span style="margin-left: 5px;">Auto Exposure</span>
                                </label>
                            </div>
                            <div id="manualExposurePanel" style="display: none;">
                                <label for="exposureSlider" style="font-size: 12px;">Exposure Time (ms)</label>
                                <input type="range" id="exposureSlider" min="1" max="100" value="10" 
                                       style="width: 100%;" onchange="setExposureTime(this.value)">
                                <span id="exposureValue" style="font-size: 12px;">10ms</span>
                            </div>
                        </div>
                        
                        <!-- ISO Controls -->
                        <div class="control-group">
                            <label for="isoSlider" style="display: block; margin-bottom: 5px; font-weight: 500;">ISO Setting</label>
                            <input type="range" id="isoSlider" min="100" max="1600" step="100" value="400" 
                                   style="width: 100%;" onchange="setISO(this.value)">
                            <span id="isoValue" style="font-size: 12px;">ISO 400</span>
                        </div>
                        
                        <!-- White Balance -->
                        <div class="control-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">White Balance</label>
                            <div style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; font-size: 14px;">
                                    <input type="checkbox" id="autoWhiteBalance" checked onchange="toggleAutoWhiteBalance(this.checked)">
                                    <span style="margin-left: 5px;">Auto White Balance</span>
                                </label>
                            </div>
                            <div id="manualWhiteBalancePanel" style="display: none;">
                                <label style="font-size: 12px; display: block; margin-bottom: 5px;">White Balance Mode</label>
                                <select id="whiteBalanceMode" style="width: 100%; padding: 4px; margin-bottom: 8px;" onchange="setWhiteBalanceMode(this.value)">
                                    <option value="indoor">üè† Indoor (Neutral)</option>
                                    <option value="daylight">‚òÄÔ∏è Daylight (Cool)</option>
                                    <option value="tungsten">üí° Tungsten (Warm)</option>
                                </select>
                                <button class="btn btn-sm btn-success" onclick="lockWhiteBalance()" style="width: 100%;">
                                    üîí Lock Current WB
                                </button>
                            </div>
                        </div>
                        
                        <!-- Color Format Debug -->
                        <div class="control-group" style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #d73027;">üîß Color Debug</label>
                            <label style="font-size: 12px; display: block; margin-bottom: 5px;">If colors look wrong, try:</label>
                            <select id="colorFormatMode" style="width: 100%; padding: 4px; margin-bottom: 8px;" onchange="setColorFormat(this.value)">
                                <option value="auto">ü§ñ Auto Detection</option>
                                <option value="rgb_to_bgr">üîÑ RGB‚ÜíBGR Convert</option>
                                <option value="bgr_direct">üéØ Direct BGR</option>
                                <option value="bgr_to_rgb">‚Ü©Ô∏è BGR‚ÜíRGB Convert</option>
                            </select>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                Change if colors appear blue/orange instead of natural colors
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Display -->
                    <div id="controlsStatus" style="margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 12px;">
                        Status: Ready
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // High-performance camera stream management
        let cameraStreamWorking = false;
        let refreshInterval = null;
        let streamCheckInterval = null;
        
        function startCameraRefresh() {
            // Initial load with immediate refresh
            refreshCameraStream();
            
            // Reduced refresh interval for smoother streaming
            refreshInterval = setInterval(refreshCameraStream, 15000);  // Every 15 seconds
            
            // Monitor stream health
            streamCheckInterval = setInterval(checkStreamHealth, 5000);  // Every 5 seconds
        }
        
        function refreshCameraStream() {
            const camera0Feed = document.getElementById('camera0Feed');
            if (camera0Feed) {
                const timestamp = Date.now();
                console.log('Refreshing Camera 0 native 1080p stream...');
                camera0Feed.src = '/camera/0?t=' + timestamp;
            }
        }
        
        function checkStreamHealth() {
            const camera0Feed = document.getElementById('camera0Feed');
            if (camera0Feed && !cameraStreamWorking) {
                console.log('Camera stream health check - refreshing...');
                refreshCameraStream();
            }
            // Reset flag for next check
            cameraStreamWorking = false;
        }
        
        function stopCameraRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (streamCheckInterval) {
                clearInterval(streamCheckInterval);
                streamCheckInterval = null;
            }
        }
        
        // Start camera refresh when page loads
        document.addEventListener('DOMContentLoaded', startCameraRefresh);
        
        // Stop refresh when page unloads
        window.addEventListener('beforeunload', stopCameraRefresh);
        
        // Camera Control Functions
        async function triggerAutofocus() {
            try {
                updateControlsStatus('Triggering autofocus...', 'info');
                
                const response = await fetch('/api/camera/autofocus', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera_id: 'camera_1' })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateControlsStatus('Autofocus triggered successfully', 'success');
                } else {
                    updateControlsStatus('Autofocus failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                updateControlsStatus('Autofocus error: ' + error.message, 'error');
                console.error('Autofocus error:', error);
            }
        }
        
        function toggleManualFocus() {
            const panel = document.getElementById('manualFocusPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Disable autofocus when switching to manual
                setCameraControls({ autofocus: false });
            }
        }
        
        async function setManualFocus(position) {
            try {
                document.getElementById('focusValue').textContent = parseFloat(position).toFixed(1);
                
                const response = await fetch('/api/camera/focus', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        camera_id: 'camera_1',
                        focus_position: parseFloat(position)
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateControlsStatus(`Manual focus set to ${position}`, 'success');
                } else {
                    updateControlsStatus('Focus setting failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                updateControlsStatus('Focus setting error: ' + error.message, 'error');
                console.error('Manual focus error:', error);
            }
        }
        
        let stabilizationEnabled = false;
        async function toggleStabilization() {
            try {
                stabilizationEnabled = !stabilizationEnabled;
                const btn = document.getElementById('stabilizeBtn');
                
                const response = await fetch('/api/camera/stabilize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        camera_id: 'camera_1',
                        enable: stabilizationEnabled
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    btn.textContent = stabilizationEnabled ? 'üîí Stabilized' : 'üîß Stabilize';
                    btn.className = stabilizationEnabled ? 'btn btn-sm btn-success' : 'btn btn-sm btn-warning';
                    updateControlsStatus(stabilizationEnabled ? 'Camera stabilization enabled' : 'Camera stabilization disabled', 'info');
                } else {
                    updateControlsStatus('Stabilization toggle failed: ' + (result.error || 'Unknown error'), 'error');
                    stabilizationEnabled = !stabilizationEnabled; // Revert on failure
                }
            } catch (error) {
                updateControlsStatus('Stabilization error: ' + error.message, 'error');
                console.error('Stabilization error:', error);
                stabilizationEnabled = !stabilizationEnabled; // Revert on failure
            }
        }
        
        function toggleAutoExposure(enabled) {
            const panel = document.getElementById('manualExposurePanel');
            panel.style.display = enabled ? 'none' : 'block';
            setCameraControls({ auto_exposure: enabled });
        }
        
        function setExposureTime(timeMs) {
            document.getElementById('exposureValue').textContent = timeMs + 'ms';
            setCameraControls({ 
                auto_exposure: false,
                exposure_time: parseInt(timeMs)
            });
        }
        
        function setISO(isoValue) {
            document.getElementById('isoValue').textContent = 'ISO ' + isoValue;
            setCameraControls({ iso: parseInt(isoValue) });
        }
        
        function toggleAutoWhiteBalance(enabled) {
            const panel = document.getElementById('manualWhiteBalancePanel');
            panel.style.display = enabled ? 'none' : 'block';
            setWhiteBalanceMode(enabled ? 'auto' : 'indoor');
        }
        
        async function setWhiteBalanceMode(mode) {
            try {
                const response = await fetch('/api/camera/white_balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        camera_id: 'camera_1',
                        mode: mode
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateControlsStatus(`White balance set to ${mode}`, 'success');
                } else {
                    updateControlsStatus('White balance setting failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                updateControlsStatus('White balance error: ' + error.message, 'error');
                console.error('White balance error:', error);
            }
        }
        
        async function lockWhiteBalance() {
            const mode = document.getElementById('whiteBalanceMode').value;
            await setWhiteBalanceMode(mode);
            updateControlsStatus(`White balance locked to ${mode} mode`, 'info');
        }
        
        async function setColorFormat(mode) {
            try {
                const response = await fetch('/api/camera/color_format', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        camera_id: 'camera_1',
                        mode: mode
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    let description = '';
                    switch(mode) {
                        case 'auto': description = 'Auto color detection enabled'; break;
                        case 'rgb_to_bgr': description = 'Forcing RGB‚ÜíBGR conversion'; break;
                        case 'bgr_direct': description = 'Using direct BGR (no conversion)'; break;
                        case 'bgr_to_rgb': description = 'Forcing BGR‚ÜíRGB conversion'; break;
                    }
                    updateControlsStatus(description, 'info');
                } else {
                    updateControlsStatus('Color format setting failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                updateControlsStatus('Color format error: ' + error.message, 'error');
                console.error('Color format error:', error);
            }
        }
        
        function toggleAutoWhiteBalance(enabled) {
            setCameraControls({ auto_white_balance: enabled });
        }
        
        async function setCameraControls(controls) {
            try {
                updateControlsStatus('Applying camera settings...', 'info');
                
                const response = await fetch('/api/camera/controls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        camera_id: 'camera_1',
                        controls: controls
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateControlsStatus('Settings applied successfully', 'success');
                } else {
                    updateControlsStatus('Settings failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                updateControlsStatus('Settings error: ' + error.message, 'error');
                console.error('Camera controls error:', error);
            }
        }
        
        function updateControlsStatus(message, type) {
            const statusElement = document.getElementById('controlsStatus');
            if (statusElement) {
                statusElement.textContent = 'Status: ' + message;
                statusElement.className = 'status-' + type;
                
                // Clear status after 3 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        statusElement.textContent = 'Status: Ready';
                        statusElement.className = '';
                    }, 3000);
                }
            }
        }
    </script>

    <!-- Activity Log Panel -->
    <section class="log-panel">
        <h2>Activity Log</h2>
        <div class="log-container">
            <div id="activityLog" class="log-content">
                <div class="log-entry info">
                    <span class="log-timestamp">{{ status.timestamp[:19] if status.timestamp else '--:--:--' }}</span>
                    <span class="log-message">Web interface initialized</span>
                </div>
            </div>
            <div class="log-controls">
                <button onclick="clearLog()" class="log-control-btn">Clear</button>
                <button onclick="downloadLog()" class="log-control-btn">Download</button>
                <label class="log-control-checkbox">
                    <input type="checkbox" id="autoScroll" checked>
                    Auto-scroll
                </label>
            </div>
        </div>
    </section>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}