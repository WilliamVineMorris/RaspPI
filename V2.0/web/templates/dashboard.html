{% extends "base.html" %}

{% block title %}Dashboard - 3D Scanner Control{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- System Status Panel -->
    <section class="status-panel">
        <h2>System Status</h2>
        <div class="status-grid">
            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Motion Controller</span>
                    <span class="status-indicator" id="motionStatus">‚óè</span>
                </div>
                <div class="status-details" id="motionDetails">
                    <div>Position: <span id="currentPosition">X:0.0 Y:0.0 Z:0.0 C:0.0</span></div>
                    <div>State: <span id="motionState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Cameras</span>
                    <span class="status-indicator" id="cameraStatus">‚óè</span>
                </div>
                <div class="status-details" id="cameraDetails">
                    <div>Available: <span id="cameraCount">0</span></div>
                    <div>Active: <span id="activeCameras">None</span></div>
                    <div>State: <span id="cameraState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Lighting</span>
                    <span class="status-indicator" id="lightingStatus">‚óè</span>
                </div>
                <div class="status-details" id="lightingDetails">
                    <div>Zones: <span id="lightingZones">0</span></div>
                    <div>Status: <span id="lightingState">Unknown</span></div>
                </div>
            </div>

            <div class="status-item">
                <div class="status-header">
                    <span class="status-label">Current Scan</span>
                    <span class="status-indicator" id="scanStatus">‚óè</span>
                </div>
                <div class="status-details" id="scanDetails">
                    <div>Progress: <span id="scanProgress">---%</span></div>
                    <div>Points: <span id="scanPoints">0/0</span></div>
                    <div>Phase: <span id="scanPhase">Idle</span></div>
                    <div>State: <span id="scanState">Unknown</span></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions Panel -->
    <section class="actions-panel">
        <h2>Quick Actions</h2>
        <div class="action-grid">
            <button class="action-btn primary" onclick="homeAllAxes()" id="homeAllBtn">
                üè† Home All
            </button>
            <button class="action-btn secondary" onclick="capturePhoto()" id="captureBtn">
                üì∏ Capture Photo
            </button>
            <button class="action-btn secondary" onclick="testLighting()" id="lightTestBtn">
                ‚ö° Test Lighting
            </button>
            <button class="action-btn tertiary" onclick="window.location.href='/manual'">
                üéÆ Manual Control
            </button>
            <button class="action-btn tertiary" onclick="window.location.href='/scans'">
                üìä Start Scan
            </button>
            <button class="action-btn tertiary" onclick="refreshStatus()">
                üîÑ Refresh Status
            </button>
        </div>
    </section>

    <!-- Camera Feeds Panel -->
    <section class="camera-panel">
        <h2>Live Camera Feed</h2>
        <div class="camera-grid">
            <div class="camera-container" style="grid-column: 1 / -1; max-width: 800px; margin: 0 auto;">
                <h3>Camera 0 - Native 1080p Stream</h3>
                <div class="camera-feed-wrapper">
                    <img id="camera0Feed" 
                         src="/camera/0?t=0" 
                         alt="Camera 0 - 1080p Stream" 
                         class="camera-feed"
                         style="width: 100%; height: auto; border-radius: 8px; max-width: 1080px;"
                         onload="cameraStreamWorking = true; console.log('Camera 0 native 1080p stream loaded');"
                         onerror="console.log('Camera 0 stream error, retrying...'); setTimeout(() => { const timestamp = Date.now(); this.src = '/camera/0?t=' + timestamp; }, 2000);">
                    <div class="camera-overlay">
                        <button class="camera-control" onclick="captureFromCamera(0)">üì∏ Capture High-Res</button>
                    </div>
                </div>
                <div class="camera-info">
                    <small>üé• Live 1080p stream ‚Ä¢ üì∏ High-res capture available during scanning</small>
                </div>
            </div>
        </div>
    </section>

    <script>
        // High-performance camera stream management
        let cameraStreamWorking = false;
        let refreshInterval = null;
        let streamCheckInterval = null;
        
        function startCameraRefresh() {
            // Initial load with immediate refresh
            refreshCameraStream();
            
            // Reduced refresh interval for smoother streaming
            refreshInterval = setInterval(refreshCameraStream, 15000);  // Every 15 seconds
            
            // Monitor stream health
            streamCheckInterval = setInterval(checkStreamHealth, 5000);  // Every 5 seconds
        }
        
        function refreshCameraStream() {
            const camera0Feed = document.getElementById('camera0Feed');
            if (camera0Feed) {
                const timestamp = Date.now();
                console.log('Refreshing Camera 0 native 1080p stream...');
                camera0Feed.src = '/camera/0?t=' + timestamp;
            }
        }
        
        function checkStreamHealth() {
            const camera0Feed = document.getElementById('camera0Feed');
            if (camera0Feed && !cameraStreamWorking) {
                console.log('Camera stream health check - refreshing...');
                refreshCameraStream();
            }
            // Reset flag for next check
            cameraStreamWorking = false;
        }
        
        function stopCameraRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (streamCheckInterval) {
                clearInterval(streamCheckInterval);
                streamCheckInterval = null;
            }
        }
        
        // Start camera refresh when page loads
        document.addEventListener('DOMContentLoaded', startCameraRefresh);
        
        // Stop refresh when page unloads
        window.addEventListener('beforeunload', stopCameraRefresh);
    </script>

    <!-- Activity Log Panel -->
    <section class="log-panel">
        <h2>Activity Log</h2>
        <div class="log-container">
            <div id="activityLog" class="log-content">
                <div class="log-entry info">
                    <span class="log-timestamp">{{ status.timestamp[:19] if status.timestamp else '--:--:--' }}</span>
                    <span class="log-message">Web interface initialized</span>
                </div>
            </div>
            <div class="log-controls">
                <button onclick="clearLog()" class="log-control-btn">Clear</button>
                <button onclick="downloadLog()" class="log-control-btn">Download</button>
                <label class="log-control-checkbox">
                    <input type="checkbox" id="autoScroll" checked>
                    Auto-scroll
                </label>
            </div>
        </div>
    </section>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}