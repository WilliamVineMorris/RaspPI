{% extends "base.html" %}

{% block title %}Manual Control - 3D Scanner Control{% endblock %}

{% block content %}
<div class="manual-control-grid">
    <!-- Position Control Panel -->
    <section class="position-control-panel">
        <h2>Position Control</h2>
        
        <!-- Current Position Display -->
        <div class="current-position">
            <h3>Current Position</h3>
            <div class="position-display">
                <div class="axis-position">
                    <label>X:</label>
                    <span id="currentX">0.0</span>mm
                </div>
                <div class="axis-position">
                    <label>Y:</label>
                    <span id="currentY">0.0</span>mm
                </div>
                <div class="axis-position">
                    <label>Z:</label>
                    <span id="currentZ">0.0</span>mm
                </div>
                <div class="axis-position">
                    <label>C:</label>
                    <span id="currentC">0.0</span>¬∞
                </div>
            </div>
        </div>

        <!-- Step Size Selection -->
        <div class="step-size-control">
            <label for="stepSize">Step Size:</label>
            <select id="stepSize" class="step-size-select">
                {% for size in step_sizes %}
                <option value="{{ size }}" {% if size == 1.0 %}selected{% endif %}>{{ size }}mm</option>
                {% endfor %}
            </select>
        </div>

        <!-- Jog Controls -->
        <div class="jog-controls">
            <!-- X-Y Control -->
            <div class="xy-control">
                <h4>X-Y Movement</h4>
                <div class="xy-grid">
                    <button class="jog-btn" onclick="jogAxis('y', getStepSize())">‚Üë</button>
                    <div class="xy-center">
                        <button class="jog-btn" onclick="jogAxis('x', -getStepSize())">‚Üê</button>
                        <button class="home-btn" onclick="homeAxes(['x', 'y'])">üè†</button>
                        <button class="jog-btn" onclick="jogAxis('x', getStepSize())">‚Üí</button>
                    </div>
                    <button class="jog-btn" onclick="jogAxis('y', -getStepSize())">‚Üì</button>
                </div>
            </div>

            <!-- Z (Rotation) Control -->
            <div class="z-control">
                <h4>Z Rotation</h4>
                <div class="z-buttons">
                    <button class="jog-btn z-up" onclick="jogAxis('z', getStepSize())">Z ‚Üª</button>
                    <button class="home-btn" onclick="homeAxes(['z'])">üè† Z</button>
                    <button class="jog-btn z-down" onclick="jogAxis('z', -getStepSize())">Z ‚Ü∫</button>
                </div>
            </div>

            <!-- C (Rotation) Control -->
            <div class="c-control">
                <h4>C Rotation</h4>
                <div class="c-buttons">
                    <button class="jog-btn c-ccw" onclick="jogAxis('c', -getStepSize())">‚Ü∫ CCW</button>
                    <button class="home-btn" onclick="homeAxes(['c'])">üè† C</button>
                    <button class="jog-btn c-cw" onclick="jogAxis('c', getStepSize())">‚Üª CW</button>
                </div>
            </div>
        </div>

        <!-- Direct Position Input -->
        <div class="direct-position">
            <h4>Go to Position</h4>
            <div class="position-inputs">
                <div class="input-group">
                    <label for="targetX">X:</label>
                    <input type="number" id="targetX" step="0.1" 
                           min="{{ position_limits.x[0] }}" 
                           max="{{ position_limits.x[1] }}" 
                           value="0.0">
                    <span>mm</span>
                </div>
                <div class="input-group">
                    <label for="targetY">Y:</label>
                    <input type="number" id="targetY" step="0.1" 
                           min="{{ position_limits.y[0] }}" 
                           max="{{ position_limits.y[1] }}" 
                           value="0.0">
                    <span>mm</span>
                </div>
                <div class="input-group">
                    <label for="targetZ">Z:</label>
                    <input type="number" id="targetZ" step="1" 
                           min="{{ position_limits.z[0] }}" 
                           max="{{ position_limits.z[1] }}" 
                           value="0.0">
                    <span>¬∞</span>
                </div>
                <div class="input-group">
                    <label for="targetC">C:</label>
                    <input type="number" id="targetC" step="1" 
                           min="{{ position_limits.c[0] }}" 
                           max="{{ position_limits.c[1] }}" 
                           value="0.0">
                    <span>¬∞</span>
                </div>
            </div>
            <button class="action-btn primary" onclick="gotoPosition()">Go to Position</button>
        </div>

        <!-- Homing Controls -->
        <div class="homing-controls">
            <h4>Homing</h4>
            <div class="home-buttons">
                <button class="action-btn secondary" onclick="homeAxes(['x'])">Home X</button>
                <button class="action-btn secondary" onclick="homeAxes(['y'])">Home Y</button>
                <button class="action-btn secondary" onclick="homeAxes(['z'])">Home Z</button>
                <button class="action-btn secondary" onclick="homeAxes(['c'])">Home C</button>
                <button class="action-btn primary" onclick="homeAllAxes()">Home All</button>
            </div>
        </div>

        <!-- Diagnostic Controls -->
        <div class="diagnostic-controls">
            <h4>Diagnostics</h4>
            <div class="diagnostic-buttons">
                <button class="action-btn secondary" onclick="ManualControl.checkBackgroundMonitor()" title="Check if position updates are working">Check Position Updates</button>
                <button class="action-btn warning" onclick="ManualControl.restartBackgroundMonitor()" title="Fix stale background monitor warnings">üîÑ Restart Monitor</button>
            </div>
        </div>
    </section>

    <!-- Camera Control Panel -->
    <section class="camera-control-panel">
        <h2>Camera Control</h2>
        
        <!-- Camera Selection -->
        <div class="camera-selection">
            <label for="activeCamera">Active Camera:</label>
            <select id="activeCamera" class="camera-select">
                <option value="0">Camera 1 (Primary)</option>
                <option value="1">Camera 2 (Secondary)</option>
                <option value="both">Both Cameras</option>
            </select>
        </div>

        <!-- Camera Actions -->
        <div class="camera-actions">
            <button class="action-btn primary" onclick="capturePhoto()" id="flashCaptureBtn">üì∏‚ö° Capture Both Cameras (Flash)</button>
            <button class="action-btn secondary" onclick="captureBothNormal()" id="normalCaptureBtn">üì∏ Capture Both Cameras (No Flash)</button>
            <br><br>
            <!-- DEBUG: Alternative test buttons -->
            <button class="action-btn primary" onclick="testCaptureFlash()" id="testFlashBtn">üî• TEST Flash Capture</button>
            <button class="action-btn secondary" onclick="testCaptureNormal()" id="testNormalBtn">üîß TEST Normal Capture</button>
            <button class="action-btn secondary" onclick="alert('Basic test button works!')" id="basicTestBtn">‚úÖ Basic Test</button>
        </div>

        <!-- Camera Preview -->
        <div class="camera-preview">
            <h4>Live Preview</h4>
            <div class="preview-container">
                <img id="activePreview" 
                     src="/camera/0" 
                     alt="Camera Preview" 
                     class="camera-preview-img"
                     onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 300 200&quot;><rect width=&quot;300&quot; height=&quot;200&quot; fill=&quot;%23f0f0f0&quot;/><text x=&quot;150&quot; y=&quot;100&quot; text-anchor=&quot;middle&quot; fill=&quot;%23666&quot;>Camera Offline</text></svg>'">
            </div>
        </div>
    </section>

    <!-- Lighting Control Panel -->
    <section class="lighting-control-panel">
        <h2>Lighting Control</h2>
        
        <!-- Zone Controls -->
        <div class="lighting-zones" id="lightingZones">
            <div class="zone-control">
                <h4>Zone 1</h4>
                <div class="zone-controls">
                    <input type="range" class="brightness-slider" 
                           min="0" max="100" value="0" 
                           id="zone1Brightness" 
                           onchange="setBrightness('zone1', this.value)">
                    <span class="brightness-value">0%</span>
                    <button class="flash-btn" onclick="flashZone('zone1')">‚ö° Flash</button>
                </div>
            </div>
        </div>

        <!-- Global Lighting Controls -->
        <div class="global-lighting">
            <h4>All Zones</h4>
            <div class="global-controls">
                <button class="action-btn secondary" onclick="testLighting()">‚ö° Test Flash</button>
                <button class="action-btn secondary" onclick="turnOnAllLights()">üí° All On</button>
                <button class="action-btn secondary" onclick="turnOffAllLights()">üåô All Off</button>
            </div>
        </div>

        <!-- Flash Settings -->
        <div class="flash-settings">
            <h4>Flash Settings</h4>
            <div class="flash-controls">
                <div class="input-group">
                    <label for="flashBrightness">Brightness:</label>
                    <input type="range" id="flashBrightness" min="10" max="100" value="80">
                    <span id="flashBrightnessValue">80%</span>
                </div>
                <div class="input-group">
                    <label for="flashDuration">Duration:</label>
                    <input type="number" id="flashDuration" min="50" max="1000" value="100" step="50">
                    <span>ms</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Status Panel -->
    <section class="manual-status-panel">
        <h2>System Status</h2>
        
        <!-- System Alarm/Status Display -->
        <div id="systemAlarmPanel" class="system-alarm-panel" style="display: none;">
            <!-- This will be populated by JavaScript with alarm/homing status -->
        </div>

        <!-- Enhanced Motion Controller Status -->
        <div class="motion-status-detail">
            <h3>Motion Controller</h3>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Connection:</span>
                    <span class="status-value" id="motionConnectionText">Unknown</span>
                    <span class="status-indicator" id="motionConnectionDot">‚óè</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Homed:</span>
                    <span class="status-value" id="motionHomedText">Unknown</span>
                    <span class="status-indicator" id="motionHomedDot">‚óè</span>
                </div>
                <div class="status-item">
                    <span class="status-label">State:</span>
                    <span class="status-value" id="motionStateText">Unknown</span>
                    <span class="status-indicator" id="motionStateDot">‚óè</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Activity:</span>
                    <span class="status-value" id="motionActivityText">Idle</span>
                </div>
            </div>
        </div>
        
        <!-- Compact System Status -->
        <div class="status-compact">
            <div class="status-row">
                <span class="status-label">Cameras:</span>
                <span class="status-value" id="cameraStatusText">Ready</span>
                <span class="status-indicator" id="cameraStatusDot">‚óè</span>
            </div>
            <div class="status-row">
                <span class="status-label">Lighting:</span>
                <span class="status-value" id="lightingStatusText">Ready</span>
                <span class="status-indicator" id="lightingStatusDot">‚óè</span>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-btn tertiary" onclick="refreshStatus()">üîÑ Refresh</button>
            <button class="action-btn tertiary" onclick="window.location.href='/'">üìä Dashboard</button>
        </div>
    </section>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Moving...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/manual-control.js') }}"></script>

<!-- DEBUG: Backup JavaScript functions directly in HTML -->
<script>
function testCaptureFlash() {
    console.log('üéØ DEBUG: testCaptureFlash called from HTML');
    alert('üî• Flash capture test from HTML!');
    
    fetch('/api/camera/capture/both', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            flash: true,
            flash_intensity: 80
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Flash capture response:', data);
        alert(`Flash capture result: ${data.success ? 'SUCCESS' : 'FAILED: ' + data.error}`);
    })
    .catch(error => {
        console.error('Flash capture error:', error);
        alert(`Flash capture error: ${error.message}`);
    });
}

function testCaptureNormal() {
    console.log('üéØ DEBUG: testCaptureNormal called from HTML');
    alert('üì∑ Normal capture test from HTML!');
    
    fetch('/api/camera/capture/both', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            flash: false
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Normal capture response:', data);
        alert(`Normal capture result: ${data.success ? 'SUCCESS' : 'FAILED: ' + data.error}`);
    })
    .catch(error => {
        console.error('Normal capture error:', error);
        alert(`Normal capture error: ${error.message}`);
    });
}

// Override the existing functions if they exist
if (typeof capturePhoto !== 'undefined') {
    console.log('üîß Original capturePhoto function exists');
} else {
    console.log('‚ö†Ô∏è Original capturePhoto function NOT found - using backup');
    window.capturePhoto = testCaptureFlash;
}

if (typeof captureBothNormal !== 'undefined') {
    console.log('üîß Original captureBothNormal function exists');  
} else {
    console.log('‚ö†Ô∏è Original captureBothNormal function NOT found - using backup');
    window.captureBothNormal = testCaptureNormal;
}
</script>
{% endblock %}