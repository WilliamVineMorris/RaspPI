<!-- Cylindrical Scan Configuration -->
<div id="cylindrical-scan-panel" class="scan-panel" style="display: none;">
    <h3>üîÑ Cylindrical Scanning</h3>
    <p>Scan cylindrical objects with multiple height passes and rotation</p>
    
    <div class="scan-config">
        <!-- Camera Radius Configuration -->
        <div class="config-group">
            <h4>üìê Camera Position</h4>
            <div class="input-group">
                <label for="radius">Camera Radius (mm):</label>
                <input type="number" id="radius" min="10" max="100" value="30" step="5">
                <small>Fixed distance from object center</small>
            </div>
        </div>
        
        <!-- Height Range Configuration -->
        <div class="config-group">
            <h4>üìè Height Scanning</h4>
            <div class="input-row">
                <div class="input-group">
                    <label for="y-min">Start Height (mm):</label>
                    <input type="number" id="y-min" min="10" max="200" value="40" step="5">
                </div>
                <div class="input-group">
                    <label for="y-max">End Height (mm):</label>
                    <input type="number" id="y-max" min="10" max="200" value="120" step="5">
                </div>
            </div>
            <div class="input-group">
                <label for="y-step">Height Step (mm):</label>
                <input type="number" id="y-step" min="5" max="50" value="20" step="5">
                <small id="height-levels">Height levels: 5</small>
            </div>
        </div>
        
        <!-- Rotation Configuration -->
        <div class="config-group">
            <h4>üîÑ Object Rotation</h4>
            <div class="input-group">
                <label for="rotation-step">Rotation Step (degrees):</label>
                <input type="number" id="rotation-step" min="15" max="90" value="60" step="15">
                <small id="rotation-count">Rotation positions: 6</small>
            </div>
            <div class="preset-buttons">
                <button type="button" onclick="setRotationStep(45)">45¬∞ (8 pos)</button>
                <button type="button" onclick="setRotationStep(60)">60¬∞ (6 pos)</button>
                <button type="button" onclick="setRotationStep(90)">90¬∞ (4 pos)</button>
            </div>
        </div>
        
        <!-- Camera Angles Configuration -->
        <div class="config-group">
            <h4>üì∑ Camera Angles</h4>
            <div class="preset-buttons">
                <button type="button" onclick="setCameraAngles([0])">Single (0¬∞)</button>
                <button type="button" onclick="setCameraAngles([-10, 0, 10])">Triple (-10¬∞, 0¬∞, 10¬∞)</button>
                <button type="button" onclick="setCameraAngles([-15, -5, 5, 15])">Quad (-15¬∞, -5¬∞, 5¬∞, 15¬∞)</button>
            </div>
            <div class="input-group">
                <label for="camera-angles">Custom Angles (comma-separated):</label>
                <input type="text" id="camera-angles" value="-10, 0, 10" placeholder="e.g., -10, 0, 10">
            </div>
        </div>
        
        <!-- Scan Summary -->
        <div class="config-group scan-summary">
            <h4>üìä Scan Summary</h4>
            <div class="summary-stats">
                <div class="stat">
                    <span class="label">Total Points:</span>
                    <span id="total-points" class="value">90</span>
                </div>
                <div class="stat">
                    <span class="label">Estimated Time:</span>
                    <span id="estimated-time" class="value">15 min</span>
                </div>
                <div class="stat">
                    <span class="label">Coverage:</span>
                    <span id="coverage-info" class="value">5 heights √ó 6 rotations √ó 3 angles</span>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="preview-scan" class="btn-secondary" onclick="previewCylindricalScan()">
                üëÅÔ∏è Preview Scan Points
            </button>
            <button id="start-cylindrical-scan" class="btn-primary" onclick="startCylindricalScan()">
                üöÄ Start Cylindrical Scan
            </button>
        </div>
    </div>
</div>

<script>
// Cylindrical Scanning JavaScript Functions

let currentCameraAngles = [-10, 0, 10];

function setRotationStep(degrees) {
    document.getElementById('rotation-step').value = degrees;
    updateRotationCount();
    updateScanSummary();
}

function setCameraAngles(angles) {
    currentCameraAngles = angles;
    document.getElementById('camera-angles').value = angles.join(', ');
    updateScanSummary();
}

function updateRotationCount() {
    const step = parseFloat(document.getElementById('rotation-step').value) || 60;
    const count = Math.floor(360 / step);
    document.getElementById('rotation-count').textContent = `Rotation positions: ${count}`;
}

function updateHeightLevels() {
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const yStep = parseFloat(document.getElementById('y-step').value) || 20;
    
    const levels = Math.floor((yMax - yMin) / yStep) + 1;
    document.getElementById('height-levels').textContent = `Height levels: ${levels}`;
}

function updateScanSummary() {
    // Get current values
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const yStep = parseFloat(document.getElementById('y-step').value) || 20;
    const rotationStep = parseFloat(document.getElementById('rotation-step').value) || 60;
    
    // Parse camera angles (use single angle for cylindrical scanning)
    const angleText = document.getElementById('camera-angles').value;
    const angles = angleText.split(',').map(a => parseFloat(a.trim())).filter(a => !isNaN(a));
    const servoAngle = angles.length > 0 ? angles[0] : 0.0;  // Single servo angle
    
    // Calculate totals (Z-axis rotations √ó Y-axis heights, C-axis fixed)
    const heightLevels = Math.floor((yMax - yMin) / yStep) + 1;
    const rotationPositions = Math.floor(360 / rotationStep);
    const totalPoints = heightLevels * rotationPositions;  // No C-axis multiplication!
    
    // Estimate time (2 seconds per point)
    const estimatedMinutes = Math.ceil(totalPoints * 2 / 60);
    
    // Update display
    document.getElementById('total-points').textContent = totalPoints;
    document.getElementById('estimated-time').textContent = `${estimatedMinutes} min`;
    document.getElementById('coverage-info').textContent = 
        `${heightLevels} heights √ó ${rotationPositions} Z-rotations (servo fixed at ${servoAngle}¬∞)`;
}

function previewCylindricalScan() {
    const config = getCylindricalScanConfig();
    
    console.log('Cylindrical Scan Preview:', config);
    
    // Show preview in console or modal
    const preview = `
üîÑ CYLINDRICAL SCAN PREVIEW
===========================
üìê Camera Radius: ${config.radius}mm (fixed)
üìè Height Range: ${config.y_min}mm to ${config.y_max}mm (step: ${config.y_step}mm)
üîÑ Rotation: Every ${config.rotation_step}¬∞ (${Math.floor(360/config.rotation_step)} positions)
üì∑ Camera Angles: ${config.c_angles.join('¬∞, ')}¬∞
üìä Total Points: ${config.estimated_points}
‚è±Ô∏è Estimated Time: ${config.estimated_time} minutes
    `;
    
    alert(preview);
}

function getCylindricalScanConfig() {
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const heightSteps = parseInt(document.getElementById('y-step').value) || 0;  // Now this is number of steps, not step size
    const rotationStep = parseFloat(document.getElementById('rotation-step').value) || 60;
    const radius = parseFloat(document.getElementById('radius').value) || 30;
    
    // üéØ NEW HEIGHT STEP CALCULATION:
    // 0 steps = 1 ring at min height
    // 1 step = 2 rings at min and max height  
    // 2+ steps = calculate intermediate heights
    let yPositions = [];
    if (heightSteps === 0) {
        // Only one ring at minimum height
        yPositions = [yMin];
    } else if (heightSteps === 1) {
        // Two rings: min and max height
        yPositions = [yMin, yMax];
    } else {
        // Multiple rings: min, intermediate heights, max
        yPositions = [yMin];
        for (let i = 1; i < heightSteps; i++) {
            const intermediate = yMin + (yMax - yMin) * (i / heightSteps);
            yPositions.push(intermediate);
        }
        yPositions.push(yMax);
    }
    
    // Use single camera angle for cylindrical scanning (C-axis fixed)
    const angleText = document.getElementById('camera-angles').value;
    const parsedAngles = angleText.split(',').map(a => parseFloat(a.trim())).filter(a => !isNaN(a));
    const servoAngle = parsedAngles.length > 0 ? parsedAngles[0] : 0.0;  // Use first angle only
    
    // Calculate statistics (Z-axis rotations √ó Y-axis heights, C-axis fixed)
    const heightLevels = yPositions.length;
    const rotationPositions = Math.floor(360 / rotationStep);
    const totalPoints = heightLevels * rotationPositions;  // No C-axis multiplication!
    const estimatedTime = Math.ceil(totalPoints * 2 / 60);
    
    // Calculate Z rotations from rotation step
    const zRotations = [];
    for (let angle = 0; angle < 360; angle += rotationStep) {
        zRotations.push(angle);
    }
    
    return {
        pattern_type: 'cylindrical',
        radius: radius,
        y_range: [yMin, yMax],           // Send as range for backend
        y_positions: yPositions,         // NEW: Explicit Y positions
        height_steps: heightSteps,       // NEW: Number of steps for reference
        z_rotations: zRotations,         // Explicit Z rotation angles
        servo_angle: servoAngle,         // Single fixed servo angle
        c_angles: [servoAngle],          // Array with single angle for backend
        estimated_points: totalPoints,
        estimated_time: estimatedTime
    };
}

async function startCylindricalScan() {
    const config = getCylindricalScanConfig();
    
    // Confirm scan start
    const confirmMessage = `
Start Cylindrical Scan?

üìä ${config.estimated_points} total positions
‚è±Ô∏è ~${config.estimated_time} minutes estimated
üìê Fixed radius: ${config.radius}mm
üìè ${Math.floor((config.y_max - config.y_min) / config.y_step) + 1} height levels  
üîÑ ${Math.floor(360 / config.rotation_step)} Z-axis rotations (cylinder)
üì∑ Fixed servo angle: ${config.servo_angle}¬∞ (C-axis)

This will capture ${config.estimated_points * 2} photos total (2 cameras).
    `;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        // Disable start button
        const startBtn = document.getElementById('start-cylindrical-scan');
        startBtn.disabled = true;
        startBtn.textContent = 'üîÑ Starting Scan...';
        
        // Send scan request to API
        const response = await fetch('/api/scan/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Cylindrical scan started successfully!\n\nScan ID: ${result.data.scan_id}\nTotal Points: ${result.data.estimated_points}`);
            
            // Switch to scan monitoring view
            if (typeof showScanMonitoring === 'function') {
                showScanMonitoring();
            }
        } else {
            throw new Error(result.error || 'Unknown error');
        }
        
    } catch (error) {
        console.error('Scan start error:', error);
        alert(`‚ùå Failed to start cylindrical scan:\n${error.message}`);
    } finally {
        // Re-enable start button
        const startBtn = document.getElementById('start-cylindrical-scan');
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Start Cylindrical Scan';
    }
}

// Auto-update calculations when values change
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for auto-update
    ['y-min', 'y-max', 'y-step', 'rotation-step', 'camera-angles'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', function() {
                updateHeightLevels();
                updateRotationCount();
                updateScanSummary();
            });
        }
    });
    
    // Initial calculations
    updateHeightLevels();
    updateRotationCount();
    updateScanSummary();
});

</script>

<style>
.scan-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 10px 0;
}

.config-group {
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.config-group h4 {
    margin: 0 0 15px 0;
    color: #495057;
    font-size: 1.1em;
}

.input-row {
    display: flex;
    gap: 15px;
}

.input-group {
    margin-bottom: 10px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #6c757d;
}

.input-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.input-group small {
    display: block;
    margin-top: 5px;
    color: #6c757d;
    font-size: 12px;
}

.preset-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.preset-buttons button {
    padding: 6px 12px;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.preset-buttons button:hover {
    background: #007bff;
    color: white;
}

.scan-summary {
    background: #e3f2fd !important;
    border-color: #2196f3 !important;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 4px;
    border: 1px solid #bbdefb;
}

.stat .label {
    font-weight: 500;
    color: #1976d2;
}

.stat .value {
    font-weight: bold;
    color: #0d47a1;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    justify-content: center;
}

.btn-primary, .btn-secondary {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #28a745;
    color: white;
}

.btn-primary:hover {
    background: #218838;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-primary:disabled {
    background: #6c757d;
    cursor: not-allowed;
}
</style>