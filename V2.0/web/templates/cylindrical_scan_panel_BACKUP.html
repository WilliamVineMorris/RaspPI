<!-- Cylindrical Scan Configuration -->
<div id="cylindrical-scan-panel" class="scan-panel" style="display: none;">
    <h3>ğŸ”„ Cylindrical Scanning</h3>
    <p>Scan cylindrical objects with multiple height passes and rotation</p>
    
    <div class="scan-config">
        <!-- Camera Radius Configuration -->
        <div class="config-group">
            <h4>ğŸ“ Camera Position</h4>
            <div class="input-group">
                <label for="radius">Camera Radius (mm):</label>
                <input type="number" id="radius" min="10" max="100" value="30" step="5">
                <small>Fixed distance from object center</small>
            </div>
        </div>
        
        <!-- Height Range Configuration -->
        <div class="config-group">
            <h4>ğŸ“ Height Scanning</h4>
            <div class="input-row">
                <div class="input-group">
                    <label for="y-min">Start Height (mm):</label>
                    <input type="number" id="y-min" min="10" max="200" value="40" step="5">
                </div>
                <div class="input-group">
                    <label for="y-max">End Height (mm):</label>
                    <input type="number" id="y-max" min="10" max="200" value="120" step="5">
                </div>
            </div>
            <div class="input-group">
                <label for="height-steps">Number of Height Steps:</label>
                <input type="number" id="height-steps" min="0" max="20" value="4" step="1">
                <small id="height-levels">Height levels: 5 (0=1 level, 1=2 levels, etc.)</small>
            </div>
        </div>
        
        <!-- Rotation Configuration -->
        <div class="config-group">
            <h4>ğŸ”„ Object Rotation</h4>
            <div class="input-group">
                <label for="rotation-positions">Number of Rotation Positions:</label>
                <input type="number" id="rotation-positions" min="3" max="72" value="6" step="1">
                <small id="rotation-details">Rotation angle: 60Â° between positions</small>
            </div>
            <div class="preset-buttons">
                <button type="button" onclick="setRotationPositions(4)">4 positions (90Â°)</button>
                <button type="button" onclick="setRotationPositions(6)">6 positions (60Â°)</button>
                <button type="button" onclick="setRotationPositions(8)">8 positions (45Â°)</button>
                <button type="button" onclick="setRotationPositions(12)">12 positions (30Â°)</button>
            </div>
        </div>
        
        <!-- Camera Angles Configuration -->
        <div class="config-group">
            <h4>ğŸ“· Camera Angles</h4>
            <div class="preset-buttons">
                <button type="button" onclick="setCameraAngles([0])">Single (0Â°)</button>
                <button type="button" onclick="setCameraAngles([-10, 0, 10])">Triple (-10Â°, 0Â°, 10Â°)</button>
                <button type="button" onclick="setCameraAngles([-15, -5, 5, 15])">Quad (-15Â°, -5Â°, 5Â°, 15Â°)</button>
            </div>
            <div class="input-group">
                <label for="camera-angles">Custom Angles (comma-separated):</label>
                <input type="text" id="camera-angles" value="-10, 0, 10" placeholder="e.g., -10, 0, 10">
            </div>
        </div>
        
        <!-- Servo Tilt Configuration -->
        <div class="config-group">
            <h4>ğŸ¯ Servo Tilt Control</h4>
            <div class="input-group">
                <label for="servo-tilt-mode">Servo Tilt Mode:</label>
                <select id="servo-tilt-mode" onchange="updateServoTiltMode()">
                    <option value="none">None - Fixed Camera Position</option>
                    <option value="manual">Manual Angle</option>
                    <option value="focus_point">Focus Point Targeting</option>
                </select>
                <small id="servo-mode-description">Camera will maintain fixed position during scanning</small>
            </div>
            
            <!-- Manual Angle Controls -->
            <div id="servo-manual-controls" class="input-group" style="display: none;">
                <label for="servo-manual-angle">Manual Servo Angle (Â°):</label>
                <input type="number" id="servo-manual-angle" min="-75" max="75" value="0" step="1">
                <small>Set servo to a fixed angle (-75Â° to +75Â°)</small>
            </div>
            
            <!-- Focus Point Controls -->
            <div id="servo-focus-controls" class="input-group" style="display: none;">
                <label for="servo-y-focus">Focus Y Position (mm):</label>
                <input type="number" id="servo-y-focus" min="10" max="200" value="80" step="5">
                <small>Y-coordinate to focus servo on during scanning</small>
            </div>
        </div>
        
        <!-- Scan Summary -->
        <div class="config-group scan-summary">
            <h4>ğŸ“Š Scan Summary</h4>
            <div class="summary-stats">
                <div class="stat">
                    <span class="label">Total Points:</span>
                    <span id="total-points" class="value">90</span>
                </div>
                <div class="stat">
                    <span class="label">Estimated Time:</span>
                    <span id="estimated-time" class="value">15 min</span>
                </div>
                <div class="stat">
                    <span class="label">Coverage:</span>
                    <span id="coverage-info" class="value">5 heights Ã— 6 rotations Ã— 3 angles</span>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="preview-scan" class="btn-secondary" onclick="previewCylindricalScan()">
                ğŸ‘ï¸ Preview Scan Points
            </button>
            <button id="start-cylindrical-scan" class="btn-primary" onclick="startCylindricalScan()">
                ğŸš€ Start Cylindrical Scan
            </button>
        </div>
    </div>
</div>

<script>
// Cylindrical Scanning JavaScript Functions

let currentCameraAngles = [-10, 0, 10];

function setRotationPositions(positions) {
    document.getElementById('rotation-positions').value = positions;
    updateRotationDetails();
    updateCylindricalScanSummary();
}

function setCameraAngles(angles) {
    currentCameraAngles = angles;
    document.getElementById('camera-angles').value = angles.join(', ');
    updateScanSummary();
}

function updateRotationDetails() {
    const positions = parseInt(document.getElementById('rotation-positions').value) || 6;
    const angle = 360 / positions;
    document.getElementById('rotation-details').textContent = `Rotation angle: ${angle.toFixed(1)}Â° between positions`;
}

function updateHeightLevels() {
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const heightSteps = parseInt(document.getElementById('height-steps').value) || 0;
    
    const levels = heightSteps + 1;  // 0 steps = 1 level, 1 step = 2 levels, etc.
    document.getElementById('height-levels').textContent = `Height levels: ${levels} (${heightSteps} steps)`;
}

// New function for servo tilt mode handling
function updateServoTiltMode() {
    const mode = document.getElementById('servo-tilt-mode').value;
    const manualControls = document.getElementById('servo-manual-controls');
    const focusControls = document.getElementById('servo-focus-controls');
    const description = document.getElementById('servo-mode-description');
    
    // Hide all controls first
    manualControls.style.display = 'none';
    focusControls.style.display = 'none';
    
    // Show appropriate controls and update description
    switch(mode) {
        case 'none':
            description.textContent = 'Camera will maintain fixed position during scanning';
            break;
        case 'manual':
            manualControls.style.display = 'block';
            description.textContent = 'Servo will be set to a fixed manual angle for all positions';
            break;
        case 'focus_point':
            focusControls.style.display = 'block';
            description.textContent = 'Servo will automatically tilt to focus on specified Y coordinate';
            break;
    }
    
    // Update scan summary to reflect servo changes
    updateCylindricalScanSummary();
}

function updateCylindricalScanSummary() {
    // Get current values
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const heightSteps = parseInt(document.getElementById('height-steps').value) || 0;
    const rotationPositions = parseInt(document.getElementById('rotation-positions').value) || 6;
    
    // Parse camera angles (use single angle for cylindrical scanning)
    const angleText = document.getElementById('camera-angles').value;
    const angles = angleText.split(',').map(a => parseFloat(a.trim())).filter(a => !isNaN(a));
    const servoAngle = angles.length > 0 ? angles[0] : 0.0;  // Single servo angle
    
    // Calculate totals (Z-axis rotations Ã— Y-axis heights, C-axis fixed)
    const heightLevels = heightSteps + 1;  // 0 steps = 1 level, etc.
    const totalPoints = heightLevels * rotationPositions;  // No C-axis multiplication!
    
    // Estimate time (2 seconds per point)
    const estimatedMinutes = Math.ceil(totalPoints * 2 / 60);
    
    // Get servo tilt status for display
    const servoMode = document.getElementById('servo-tilt-mode').value;
    let servoInfo = '';
    switch(servoMode) {
        case 'none':
            servoInfo = `servo fixed at ${servoAngle}Â°`;
            break;
        case 'manual':
            const manualAngle = parseFloat(document.getElementById('servo-manual-angle').value) || 0;
            servoInfo = `servo at manual ${manualAngle}Â°`;
            break;
        case 'focus_point':
            const focusY = parseFloat(document.getElementById('servo-y-focus').value) || 80;
            servoInfo = `servo targeting Y=${focusY}mm`;
            break;
    }
    
    // Update display
    document.getElementById('total-points').textContent = totalPoints;
    document.getElementById('estimated-time').textContent = `${estimatedMinutes} min`;
    document.getElementById('coverage-info').textContent = 
        `${heightLevels} heights Ã— ${rotationPositions} Z-rotations (${servoInfo})`;
}

function previewCylindricalScan() {
    const config = getCylindricalScanConfig();
    
    // Create preview text
    const preview = `
ğŸ“‹ Cylindrical Scan Preview

ğŸ“ Setup:
   Camera radius: ${config.radius}mm
   Height range: ${config.y_min}mm to ${config.y_max}mm (${config.height_steps + 1} levels)
   Rotation positions: ${config.rotation_positions} (${(360/config.rotation_positions).toFixed(1)}Â° steps)

ğŸ¯ Servo Configuration:
   Mode: ${config.servo_tilt_mode}
   ${config.servo_tilt_mode === 'manual' ? `Manual angle: ${config.servo_manual_angle}Â°` : ''}
   ${config.servo_tilt_mode === 'focus_point' ? `Focus Y position: ${config.servo_y_focus}mm` : ''}
   ${config.servo_tilt_mode === 'none' ? `Fixed servo angle: ${config.servo_angle}Â°` : ''}

ğŸ“Š Totals:
   Total scan points: ${config.total_points}
   Estimated time: ${Math.ceil(config.total_points * 2 / 60)} minutes
   
ğŸ” Details:
   ${config.coverage_details}
`;
    
    alert(preview);
}

function getCylindricalScanConfig() {
    // Get basic scan parameters
    const radius = parseFloat(document.getElementById('radius').value) || 30;
    const yMin = parseFloat(document.getElementById('y-min').value) || 40;
    const yMax = parseFloat(document.getElementById('y-max').value) || 120;
    const heightSteps = parseInt(document.getElementById('height-steps').value) || 0;
    const rotationPositions = parseInt(document.getElementById('rotation-positions').value) || 6;
    
    // Parse camera angles (use single angle for cylindrical scanning)
    const angleText = document.getElementById('camera-angles').value;
    const parsedAngles = angleText.split(',').map(a => parseFloat(a.trim())).filter(a => !isNaN(a));
    const servoAngle = parsedAngles.length > 0 ? parsedAngles[0] : 0.0;  // Use first angle only
    
    // Get servo tilt configuration
    const servoTiltMode = document.getElementById('servo-tilt-mode').value;
    const servoManualAngle = parseFloat(document.getElementById('servo-manual-angle').value) || 0;
    const servoYFocus = parseFloat(document.getElementById('servo-y-focus').value) || 80;
    
    // Calculate totals
    const heightLevels = heightSteps + 1;
    const totalPoints = heightLevels * rotationPositions;
    
    // Coverage details based on servo mode
    let coverageDetails;
    switch(servoTiltMode) {
        case 'manual':
            coverageDetails = `${heightLevels} heights Ã— ${rotationPositions} Z-rotations (servo at manual ${servoManualAngle}Â°)`;
            break;
        case 'focus_point':
            coverageDetails = `${heightLevels} heights Ã— ${rotationPositions} Z-rotations (servo targeting Y=${servoYFocus}mm)`;
            break;
        default:
            coverageDetails = `${heightLevels} heights Ã— ${rotationPositions} Z-rotations (servo fixed at ${servoAngle}Â°)`;
    }
    
    return {
        pattern: 'cylindrical',
        radius: radius,
        y_min: yMin,
        y_max: yMax,
        height_steps: heightSteps,
        rotation_positions: rotationPositions,
        servo_angle: servoAngle,         // Single fixed servo angle (for none mode)
        c_angles: [servoAngle],          // Array with single angle for backend
        total_points: totalPoints,
        coverage_details: coverageDetails,
        scan_name: document.getElementById('scan-name')?.value || 'Cylindrical_Scan',
        
        // New servo tilt parameters
        servo_tilt_mode: servoTiltMode,
        servo_manual_angle: servoManualAngle,
        servo_y_focus: servoYFocus
    };
}

function startCylindricalScan() {
    const config = getCylindricalScanConfig();
    
    // Validation
    if (config.radius < 10 || config.radius > 100) {
        alert('âŒ Camera radius must be between 10-100mm');
        return;
    }
    
    if (config.y_min >= config.y_max) {
        alert('âŒ Start height must be less than end height');
        return;
    }
    
    if (config.rotation_positions < 3) {
        alert('âŒ Must have at least 3 rotation positions');
        return;
    }
    
    // Servo tilt validation
    if (config.servo_tilt_mode === 'manual') {
        if (config.servo_manual_angle < -75 || config.servo_manual_angle > 75) {
            alert('âŒ Manual servo angle must be between -75Â° and +75Â°');
            return;
        }
    }
    
    if (config.servo_tilt_mode === 'focus_point') {
        if (config.servo_y_focus < config.y_min || config.servo_y_focus > config.y_max) {
            alert('âŒ Focus Y position should be within the scan height range');
            return;
        }
    }
    
    // Show confirmation with servo details
    let servoInfo = '';
    switch(config.servo_tilt_mode) {
        case 'manual':
            servoInfo = ` with manual servo angle ${config.servo_manual_angle}Â°`;
            break;
        case 'focus_point':
            servoInfo = ` with servo targeting focus point Y=${config.servo_y_focus}mm`;
            break;
        default:
            servoInfo = ` with fixed servo at ${config.servo_angle}Â°`;
    }
    
    const confirmation = `ğŸš€ Start cylindrical scan?

ğŸ“Š ${config.total_points} total points
â±ï¸ ~${Math.ceil(config.total_points * 2 / 60)} minutes
ğŸ¯${servoInfo}

ğŸ“‹ ${config.coverage_details}
`;
    
    if (confirm(confirmation)) {
        // Display scan starting message
        displayNotification('ğŸš€ Starting cylindrical scan...', 'info');
        
        // Send to backend
        fetch('/api/scan/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayNotification(`âœ… Cylindrical scan started successfully! (${config.total_points} points)`, 'success');
                console.log('Scan started:', data);
            } else {
                displayNotification(`âŒ Failed to start scan: ${data.error}`, 'error');
                console.error('Scan start failed:', data.error);
            }
        })
        .catch(error => {
            displayNotification(`âŒ Network error: ${error.message}`, 'error');
            console.error('Network error:', error);
        });
    }
}

// Event listeners for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    // Update summaries when values change
    ['y-min', 'y-max', 'height-steps', 'rotation-positions', 'camera-angles'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', function() {
                if (id.includes('height')) updateHeightLevels();
                if (id.includes('rotation')) updateRotationDetails();
                updateCylindricalScanSummary();
            });
        }
    });
    
    // Update servo controls when mode changes
    const servoModeSelect = document.getElementById('servo-tilt-mode');
    if (servoModeSelect) {
        servoModeSelect.addEventListener('change', updateServoTiltMode);
    }
    
    // Update summary when servo values change
    ['servo-manual-angle', 'servo-y-focus'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateCylindricalScanSummary);
        }
    });
    
    // Initialize displays
    updateRotationDetails();
    updateHeightLevels();
    updateServoTiltMode();
    updateCylindricalScanSummary();
});

</script>